<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thunderbird Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0,0,0,0.9);
            padding: 20px 0;
            border-bottom: 3px solid #e74c3c;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #e74c3c, #ff6b6b);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .admin-badge {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 100px auto 0;
            padding: 30px 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 3px solid rgba(231, 76, 60, 0.3);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: #e74c3c;
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(231, 76, 60, 0.2);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #e74c3c;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(231, 76, 60, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #e74c3c;
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .file-list {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .file-name {
            color: #ecf0f1;
            font-weight: 600;
        }

        .file-details {
            color: #95a5a6;
            font-size: 0.8rem;
        }

        .stream-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stream-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }

        .stream-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .stream-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-active {
            background: #27ae60;
            color: white;
        }

        .status-inactive {
            background: #7f8c8d;
            color: white;
        }

        .cleanup-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .cleanup-card {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            text-align: center;
        }

        .cleanup-title {
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .log-container {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 20px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            margin-bottom: 5px;
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: #95a5a6;
            min-width: 80px;
        }

        .log-message {
            color: #ecf0f1;
        }

        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .stream-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <span>Thunderbird Admin</span>
            </div>
            <div class="admin-badge">
                üõ°Ô∏è Administrator Panel
            </div>
        </div>
    </header>

    <div class="container">
        <!-- System Overview -->
        <div class="panel">
            <div class="panel-title">
                <span>üìä</span>
                System Overview
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="active-streams">0</div>
                    <div class="stat-label">Active Streams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="disk-usage">--</div>
                    <div class="stat-label">Disk Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uptime">--</div>
                    <div class="stat-label">System Uptime</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-viewers">--</div>
                    <div class="stat-label">Live Connections</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Stream Management -->
            <div class="panel">
                <div class="panel-title">
                    <span>üé•</span>
                    Stream Management
                </div>
                <div class="stream-controls">
                    <div class="stream-card">
                        <div class="stream-title">Stream 1</div>
                        <div class="stream-status status-inactive" id="stream1-status">Inactive</div>
                        <div>
                            <button class="btn btn-success" onclick="controlStream('stream1', 'start')">Start</button>
                            <button class="btn btn-danger" onclick="controlStream('stream1', 'stop')">Stop</button>
                            <button class="btn btn-info" onclick="controlStream('stream1', 'restart')">Restart</button>
                        </div>
                    </div>
                    <div class="stream-card">
                        <div class="stream-title">Stream 2</div>
                        <div class="stream-status status-inactive" id="stream2-status">Inactive</div>
                        <div>
                            <button class="btn btn-success" onclick="controlStream('stream2', 'start')">Start</button>
                            <button class="btn btn-danger" onclick="controlStream('stream2', 'stop')">Stop</button>
                            <button class="btn btn-info" onclick="controlStream('stream2', 'restart')">Restart</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-info" onclick="refreshStreams()">üîÑ Refresh Status</button>
                    <button class="btn btn-warning" onclick="viewNginxStats()">üìà View nginx Stats</button>
                    <button class="btn btn-success" onclick="forceRefresh()">‚ö° Force Refresh All</button>
                </div>
            </div>

            <!-- File Management -->
            <div class="panel">
                <div class="panel-title">
                    <span>üóÇÔ∏è</span>
                    File Management
                </div>
                
                <div class="cleanup-options">
                    <div class="cleanup-card">
                        <div class="cleanup-title">HLS Segments</div>
                        <button class="btn btn-warning" onclick="cleanupFiles('hls', 'older-than-hour')">Clean > 1 Hour</button>
                        <button class="btn btn-danger" onclick="cleanupFiles('hls', 'all')">Clean All</button>
                    </div>
                    <div class="cleanup-card">
                        <div class="cleanup-title">Recordings</div>
                        <button class="btn btn-warning" onclick="cleanupFiles('recordings', 'older-than-day')">Clean > 1 Day</button>
                        <button class="btn btn-danger" onclick="cleanupFiles('recordings', 'all')">Clean All</button>
                    </div>
                    <div class="cleanup-card">
                        <div class="cleanup-title">Logs</div>
                        <button class="btn btn-warning" onclick="cleanupFiles('logs', 'older-than-week')">Clean > 1 Week</button>
                        <button class="btn btn-info" onclick="viewLogs()">View Logs</button>
                    </div>
                </div>

                <div class="file-list" id="file-list">
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">Loading file information...</div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-info" onclick="refreshFileList()">üîÑ Refresh Files</button>
                    <button class="btn btn-success" onclick="downloadLogs()">üì• Download Logs</button>
                </div>
            </div>
        </div>

        <!-- System Monitoring -->
        <div class="panel">
            <div class="panel-title">
                <span>üñ•Ô∏è</span>
                System Monitoring & Activity Log
            </div>
            <div class="log-container" id="log-container">
                <!-- Logs will be populated here -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-info" onclick="clearLogs()">üóëÔ∏è Clear Display</button>
                <button class="btn btn-success" onclick="exportSystemReport()">üìä Export Report</button>
                <button class="btn btn-warning" onclick="restartSystem()">üîÑ Restart Services</button>
            </div>
        </div>
    </div>

    <script>
        let systemStartTime = Date.now();
        let logEntries = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            logEntries.push(entry);
            
            const logContainer = document.getElementById('log-container');
            const logElement = document.createElement('div');
            logElement.className = 'log-entry';
            
            logElement.innerHTML = `
                <span class="log-time">${timestamp}</span>
                <span class="log-message log-${type}">${message}</span>
            `;
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 entries
            if (logEntries.length > 100) {
                logEntries.shift();
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function updateSystemStats() {
            // Simulate system uptime
            const uptime = Math.floor((Date.now() - systemStartTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
            
            // Update other stats (these would normally come from backend API)
            fetchDiskUsage();
            checkActiveStreams();
        }

        function fetchDiskUsage() {
            // Get real disk usage from integrated API
            fetch('/api/admin/disk-usage')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Disk usage data received:', data);
                    if (data.status === 'success') {
                        const hls = data.data.hls_usage || '0B';
                        document.getElementById('disk-usage').textContent = hls;
                        addLog(`Disk usage updated: HLS=${hls}`, 'success');
                    } else {
                        document.getElementById('disk-usage').textContent = '--';
                        addLog('Disk usage API error: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Disk usage fetch error:', error);
                    document.getElementById('disk-usage').textContent = '--';
                    addLog('Disk usage API error: ' + error.message, 'error');
                });
        }

        function checkActiveStreams() {
            // Get stream info from integrated API
            fetch('/api/admin/streams')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Stream data received:', data);
                    if (data.status === 'success') {
                        const activeStreams = data.data.active_streams || 0;
                        const totalViewers = data.data.total_viewers || 0;
                        
                        document.getElementById('active-streams').textContent = activeStreams;
                        // Show minimum 1 connection per active stream (the streamer)
                        const minConnections = activeStreams > 0 ? activeStreams : 0;
                        document.getElementById('total-viewers').textContent = minConnections;
                        addLog(`Streams updated: ${activeStreams} active streams, ${minConnections} min connections`, 'success');
                    } else {
                        document.getElementById('active-streams').textContent = '0';
                        document.getElementById('total-viewers').textContent = '--';
                        addLog('API returned error: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Stream fetch error:', error);
                    document.getElementById('active-streams').textContent = '0';
                    document.getElementById('total-viewers').textContent = '--';
                    addLog('Stream API error: ' + error.message, 'error');
                });
        }

        function controlStream(streamName, action) {
            addLog(`${action.toUpperCase()} command sent to ${streamName}`, 'info');
            
            // Update UI immediately
            const statusElement = document.getElementById(`${streamName}-status`);
            statusElement.textContent = 'Processing...';
            
            // Send actual API request
            fetch('/api/admin/streams', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: action,
                    stream: streamName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (action === 'stop') {
                        statusElement.textContent = 'Inactive';
                        statusElement.className = 'stream-status status-inactive';
                    } else {
                        statusElement.textContent = 'Ready';
                        statusElement.className = 'stream-status status-active';
                    }
                    addLog(data.message, 'success');
                    
                    if (data.rtmp_url) {
                        addLog(`RTMP URL: ${data.rtmp_url}`, 'info');
                    }
                } else if (data.status === 'warning') {
                    statusElement.textContent = 'Inactive';
                    statusElement.className = 'stream-status status-inactive';
                    addLog(data.message, 'warning');
                } else if (data.status === 'info') {
                    statusElement.textContent = 'Ready';
                    statusElement.className = 'stream-status status-active';
                    addLog(data.message, 'info');
                    
                    if (data.rtmp_url) {
                        addLog(`RTMP URL: ${data.rtmp_url}`, 'info');
                    }
                } else {
                    statusElement.textContent = 'Error';
                    statusElement.className = 'stream-status status-inactive';
                    addLog(data.message, 'error');
                }
            })
            .catch(error => {
                statusElement.textContent = 'Error';
                statusElement.className = 'stream-status status-inactive';
                addLog(`Failed to ${action} ${streamName}: ${error.message}`, 'error');
            });
        }

        function cleanupFiles(type, timeframe) {
            const typeNames = {
                'hls': 'HLS segments',
                'recordings': 'recording files',
                'logs': 'log files'
            };
            
            const timeNames = {
                'older-than-hour': 'older than 1 hour',
                'older-than-day': 'older than 1 day',
                'older-than-week': 'older than 1 week',
                'all': 'all files'
            };
            
            if (confirm(`Are you sure you want to delete ${typeNames[type]} ${timeNames[timeframe]}?`)) {
                addLog(`Cleaning up ${typeNames[type]} ${timeNames[timeframe]}...`, 'warning');
                
                // Convert timeframe names to script parameters
                const timeframeMap = {
                    'older-than-hour': 'hour',
                    'older-than-day': 'day',
                    'older-than-week': 'week',
                    'all': 'all'
                };
                
                // Send actual cleanup request
                fetch('/api/admin/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: type,
                        timeframe: timeframeMap[timeframe]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        addLog(`Cleanup completed: ${data.message}`, 'success');
                        if (data.output) {
                            // Parse output for detailed info
                            const lines = data.output.split('\n');
                            lines.forEach(line => {
                                if (line.trim() && line.includes('cleanup completed')) {
                                    addLog(line.trim(), 'success');
                                }
                            });
                        }
                    } else {
                        addLog(`Cleanup failed: ${data.message}`, 'error');
                    }
                    refreshFileList();
                    fetchDiskUsage(); // Update disk usage stats
                })
                .catch(error => {
                    addLog(`Cleanup request failed: ${error.message}`, 'error');
                });
            }
        }

        function refreshFileList() {
            addLog('Refreshing file list...', 'info');
            
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '<div class="file-item"><div class="file-info"><div class="file-name">Loading...</div></div></div>';
            
            // Get real file information from API
            fetch('/api/admin/files')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        let fileListHTML = '';
                        
                        data.data.files.forEach(fileInfo => {
                            const sizeInMB = Math.round(fileInfo.total_size / (1024 * 1024));
                            const lastModified = new Date(fileInfo.last_modified).toLocaleString();
                            
                            if (fileInfo.type === 'hls') {
                                fileListHTML += `
                                    <div class="file-item">
                                        <div class="file-info">
                                            <div class="file-name">${fileInfo.path}</div>
                                            <div class="file-details">${fileInfo.ts_count} segments, ${sizeInMB}MB, Last: ${lastModified}</div>
                                        </div>
                                        <button class="btn btn-danger" onclick="cleanupFiles('hls', 'all')">Clean</button>
                                    </div>
                                `;
                            } else if (fileInfo.type === 'recordings') {
                                fileListHTML += `
                                    <div class="file-item">
                                        <div class="file-info">
                                            <div class="file-name">${fileInfo.path}</div>
                                            <div class="file-details">${fileInfo.file_count} files, ${sizeInMB}MB, Last: ${lastModified}</div>
                                        </div>
                                        <button class="btn btn-danger" onclick="cleanupFiles('recordings', 'all')">Clean</button>
                                    </div>
                                `;
                            }
                        });
                        
                        // Add logs directory (always present)
                        fileListHTML += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">/root/STREAMFORGE/logs/</div>
                                    <div class="file-details">Log files, Last modified: Now</div>
                                </div>
                                <button class="btn btn-warning" onclick="viewLogs()">View</button>
                            </div>
                        `;
                        
                        if (data.data.files.length === 0) {
                            fileListHTML = `
                                <div class="file-item">
                                    <div class="file-info">
                                        <div class="file-name">No active file storage detected</div>
                                        <div class="file-details">All directories are clean</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        fileList.innerHTML = fileListHTML;
                        addLog('File list refreshed from server', 'success');
                    } else {
                        fileList.innerHTML = '<div class="file-item"><div class="file-info"><div class="file-name">Failed to load file information</div></div></div>';
                        addLog('Failed to refresh file list', 'error');
                    }
                })
                .catch(error => {
                    fileList.innerHTML = '<div class="file-item"><div class="file-info"><div class="file-name">Error loading files</div></div></div>';
                    addLog(`File list refresh failed: ${error.message}`, 'error');
                });
        }

        function viewNginxStats() {
            window.open('http://188.245.163.8:8080/stat', '_blank');
            addLog('Opened nginx-rtmp statistics page', 'info');
        }

        function viewLogs() {
            addLog('Opening log viewer...', 'info');
            // This would open a detailed log viewer
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
            logEntries = [];
            addLog('Log display cleared', 'info');
        }

        function refreshStreams() {
            addLog('Refreshing stream status...', 'info');
            checkActiveStreams();
        }

        function downloadLogs() {
            addLog('Preparing log download...', 'info');
            // Simulate download
            setTimeout(() => {
                addLog('Log files downloaded successfully', 'success');
            }, 1500);
        }

        function exportSystemReport() {
            addLog('Generating system report...', 'info');
            setTimeout(() => {
                addLog('System report exported successfully', 'success');
            }, 2000);
        }

        function restartSystem() {
            if (confirm('Are you sure you want to restart all services? This will temporarily interrupt streaming.')) {
                addLog('Restarting system services...', 'warning');
                setTimeout(() => {
                    addLog('All services restarted successfully', 'success');
                }, 5000);
            }
        }

        // Initialize dashboard
        function initDashboard() {
            addLog('Thunderbird Admin Dashboard initialized', 'success');
            addLog('nginx-rtmp service running on port 1935', 'info');
            addLog('HTTP server running on port 8080', 'info');
            addLog('Web proxy running on port 3000', 'info');
            
            // Force immediate data refresh
            setTimeout(() => {
                addLog('Loading real-time data...', 'info');
                fetchDiskUsage();
                checkActiveStreams();
                refreshFileList();
            }, 1000);
            
            updateSystemStats();
            
            // Update stats every 10 seconds for testing
            setInterval(updateSystemStats, 10000);
        }
        
        // Manual refresh function
        function forceRefresh() {
            addLog('Manual refresh triggered', 'info');
            fetchDiskUsage();
            checkActiveStreams();
            refreshFileList();
        }

        // Start dashboard when page loads
        window.onload = initDashboard;
    </script>
</body>
</html>