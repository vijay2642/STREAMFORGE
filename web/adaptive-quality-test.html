<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Quality Test</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        video {
            width: 100%;
            max-width: 640px;
            background: #000;
        }
        .quality-controls {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover { background: #2980b9; }
        .active { background: #27ae60 !important; }
        .metrics {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Adaptive Quality Streaming</h1>
    
    <video id="video" controls muted playsinline></video>
    
    <div class="quality-controls">
        <h3>Quality Control</h3>
        <button onclick="setQuality('auto')" id="auto-btn" class="active">Auto (Adaptive)</button>
        <button onclick="setQuality('high')" id="high-btn">High Quality</button>
        <button onclick="setQuality('medium')" id="medium-btn">Medium Quality</button>
        <button onclick="setQuality('low')" id="low-btn">Low Quality</button>
    </div>

    <div class="metrics">
        <div id="metrics">Ready to test adaptive streaming...</div>
    </div>

    <script>
        let hls = null;
        let currentQuality = 'auto';

        function updateMetrics(info) {
            document.getElementById('metrics').innerHTML = info;
        }

        function setQuality(quality) {
            currentQuality = quality;
            
            // Update button states
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(quality + '-btn').classList.add('active');
            
            if (hls) {
                configureQuality(quality);
            }
            
            updateMetrics(`Quality set to: ${quality}`);
        }

        function configureQuality(quality) {
            const configs = {
                'auto': {
                    maxBufferLength: 3,
                    maxMaxBufferLength: 6,
                    maxBandwidth: undefined,
                    startLevel: -1  // Auto
                },
                'high': {
                    maxBufferLength: 6,
                    maxMaxBufferLength: 12,
                    maxBandwidth: undefined,
                    startLevel: 0  // Force highest available
                },
                'medium': {
                    maxBufferLength: 4,
                    maxMaxBufferLength: 8,
                    maxBandwidth: 2000000,  // 2 Mbps limit
                    startLevel: -1
                },
                'low': {
                    maxBufferLength: 2,
                    maxMaxBufferLength: 4,
                    maxBandwidth: 800000,   // 800 Kbps limit
                    startLevel: -1
                }
            };
            
            const config = configs[quality];
            
            // Apply bandwidth limit
            if (config.maxBandwidth) {
                hls.config.maxBandwidth = config.maxBandwidth;
            } else {
                delete hls.config.maxBandwidth;
            }
            
            // Adjust buffer settings
            hls.config.maxBufferLength = config.maxBufferLength;
            hls.config.maxMaxBufferLength = config.maxMaxBufferLength;
            
            updateMetrics(`Applied ${quality} quality settings`);
        }

        function startStream() {
            const video = document.getElementById('video');
            const url = 'http://188.245.163.8:8080/hls/stream1/index.m3u8';
            
            if (hls) {
                hls.destroy();
            }

            // Base config optimized for nginx-rtmp
            const config = {
                debug: false,
                enableWorker: true,
                lowLatencyMode: true,
                liveSyncDurationCount: 1,
                fragLoadingTimeOut: 5000,
                // Will be overridden by quality settings
                maxBufferLength: 3,
                maxMaxBufferLength: 6
            };

            hls = new Hls(config);
            
            // Apply current quality settings
            configureQuality(currentQuality);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                updateMetrics('‚úÖ Stream loaded with adaptive quality');
            });

            hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
                updateMetrics(`üîÑ Quality changed to level ${data.level}`);
            });

            hls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                const loadTime = Math.round(data.stats.loading.end - data.stats.loading.start);
                const bitrate = Math.round(data.frag.level ? hls.levels[data.frag.level].bitrate / 1000 : 0);
                updateMetrics(`üìä Segment: ${loadTime}ms, Bitrate: ${bitrate}k, Quality: ${currentQuality}`);
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                updateMetrics(`‚ùå Error: ${data.details}`);
            });

            video.addEventListener('waiting', () => {
                updateMetrics('‚è≥ Buffering...');
            });

            video.addEventListener('playing', () => {
                updateMetrics(`üé¨ Playing with ${currentQuality} quality`);
            });

            hls.loadSource(url);
            hls.attachMedia(video);
            
            video.play().catch(e => {
                updateMetrics(`‚ùå Play error: ${e.message}`);
            });
        }

        // Auto-start
        startStream();
    </script>
</body>
</html>